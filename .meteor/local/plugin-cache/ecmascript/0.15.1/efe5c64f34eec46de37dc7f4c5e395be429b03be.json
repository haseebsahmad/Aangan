{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Users\\Haseeb\\Desktop\\Aangan-main\\Aangan-main\\packages\\ostrio:files\\upload.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.cordova"},"sourceFileName":"packages/ostrio:files/upload.js","filename":"C:\\Users\\Haseeb\\Desktop\\Aangan-main\\Aangan-main\\packages\\ostrio:files\\upload.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"C:\\Users\\Haseeb\\Desktop\\Aangan-main\\Aangan-main","root":"C:\\Users\\Haseeb\\Desktop\\Aangan-main\\Aangan-main","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"C:\\Users\\Haseeb\\Desktop\\Aangan-main\\Aangan-main\\packages\\ostrio:files\\upload.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/ostrio:files/upload.js"}},"code":"var _inheritsLoose;\n\nmodule.link(\"@babel/runtime/helpers/inheritsLoose\", {\n  default: function (v) {\n    _inheritsLoose = v;\n  }\n}, 0);\nmodule.export({\n  FileUpload: function () {\n    return FileUpload;\n  },\n  UploadInstance: function () {\n    return UploadInstance;\n  }\n});\nvar HTTP;\nmodule.link(\"meteor/http\", {\n  HTTP: function (v) {\n    HTTP = v;\n  }\n}, 0);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 1);\nvar Random;\nmodule.link(\"meteor/random\", {\n  Random: function (v) {\n    Random = v;\n  }\n}, 2);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 3);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 4);\nvar EventEmitter;\nmodule.link(\"eventemitter3\", {\n  EventEmitter: function (v) {\n    EventEmitter = v;\n  }\n}, 5);\nvar check, Match;\nmodule.link(\"meteor/check\", {\n  check: function (v) {\n    check = v;\n  },\n  Match: function (v) {\n    Match = v;\n  }\n}, 6);\nvar fixJSONParse, fixJSONStringify, helpers;\nmodule.link(\"./lib.js\", {\n  fixJSONParse: function (v) {\n    fixJSONParse = v;\n  },\n  fixJSONStringify: function (v) {\n    fixJSONStringify = v;\n  },\n  helpers: function (v) {\n    helpers = v;\n  }\n}, 7);\n\nvar _rootUrl = (window.__meteor_runtime_config__.MOBILE_ROOT_URL || window.__meteor_runtime_config__.ROOT_URL).replace(/\\/+$/, '');\n\nvar isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n/*\n * @locus Client\n * @name FileUpload\n * @class FileUpload\n * @summary Internal Class, instance of this class is returned from `.insert()` method\n */\n\nvar FileUpload = /*#__PURE__*/function (_EventEmitter) {\n  _inheritsLoose(FileUpload, _EventEmitter);\n\n  function FileUpload(config) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    _this.config = config;\n\n    _this.config._debug('[FilesCollection] [FileUpload] [constructor]');\n\n    if (!_this.config.isBase64) {\n      _this.file = Object.assign({}, helpers.clone(_this.config.file), _this.config.fileData);\n    } else {\n      _this.file = _this.config.fileData;\n    }\n\n    _this.state = new ReactiveVar('active');\n    _this.onPause = new ReactiveVar(false);\n    _this.progress = new ReactiveVar(0);\n\n    _this.continueFunc = function () {};\n\n    _this.estimateTime = new ReactiveVar(1000);\n    _this.estimateSpeed = new ReactiveVar(0);\n    _this.estimateTimer = Meteor.setInterval(function () {\n      if (_this.state.get() === 'active') {\n        var _currentTime = _this.estimateTime.get();\n\n        if (_currentTime > 1000) {\n          _this.estimateTime.set(_currentTime - 1000);\n        }\n      }\n    }, 1000);\n    return _this;\n  }\n\n  var _proto = FileUpload.prototype;\n\n  _proto.pause = function () {\n    function pause() {\n      this.config._debug('[FilesCollection] [insert] [.pause()]');\n\n      if (!this.onPause.get()) {\n        this.onPause.set(true);\n        this.state.set('paused');\n        this.emit('pause', this.file);\n      }\n    }\n\n    return pause;\n  }();\n\n  _proto.continue = function () {\n    function _continue() {\n      this.config._debug('[FilesCollection] [insert] [.continue()]');\n\n      if (this.onPause.get()) {\n        this.onPause.set(false);\n        this.state.set('active');\n        this.emit('continue', this.file);\n        this.continueFunc();\n      }\n    }\n\n    return _continue;\n  }();\n\n  _proto.toggle = function () {\n    function toggle() {\n      this.config._debug('[FilesCollection] [insert] [.toggle()]');\n\n      if (this.onPause.get()) {\n        this.continue();\n      } else {\n        this.pause();\n      }\n    }\n\n    return toggle;\n  }();\n\n  _proto.abort = function () {\n    function abort() {\n      this.config._debug('[FilesCollection] [insert] [.abort()]');\n\n      window.removeEventListener('beforeunload', this.config.beforeunload, false);\n      this.pause();\n\n      this.config._onEnd();\n\n      this.state.set('aborted');\n      this.config.onAbort && this.config.onAbort.call(this, this.file);\n      this.emit('abort', this.file);\n\n      if (this.config.debug) {\n        console.timeEnd(\"insert \" + this.config.fileData.name);\n      }\n\n      this.config.ddp.call(this.config._Abort, this.config.fileId);\n    }\n\n    return abort;\n  }();\n\n  return FileUpload;\n}(EventEmitter);\n\nvar UploadInstance = /*#__PURE__*/function (_EventEmitter2) {\n  _inheritsLoose(UploadInstance, _EventEmitter2);\n\n  function UploadInstance(config, collection) {\n    var _this2;\n\n    _this2 = _EventEmitter2.call(this) || this;\n    _this2.config = config;\n    _this2.collection = collection;\n\n    _this2.collection._debug('[FilesCollection] [insert()]');\n\n    if (!_this2.config.ddp) {\n      _this2.config.ddp = _this2.collection.ddp;\n    }\n\n    if (!_this2.config.meta) {\n      _this2.config.meta = {};\n    }\n\n    if (!_this2.config.streams) {\n      _this2.config.streams = 2;\n    }\n\n    if (_this2.config.streams < 1) {\n      _this2.config.streams = 2;\n    }\n\n    if (!helpers.isString(_this2.config.transport)) {\n      _this2.config.transport = 'ddp';\n    }\n\n    _this2.config.transport = _this2.config.transport.toLowerCase();\n\n    if (_this2.config.transport !== 'ddp' && _this2.config.transport !== 'http') {\n      _this2.config.transport = 'ddp';\n    }\n\n    if (!_this2.config.chunkSize) {\n      _this2.config.chunkSize = _this2.collection.chunkSize;\n    }\n\n    if (!helpers.isBoolean(_this2.config.allowWebWorkers)) {\n      _this2.config.allowWebWorkers = true;\n    }\n\n    check(_this2.config, {\n      ddp: Match.Any,\n      file: Match.Any,\n      fileId: Match.Optional(String),\n      meta: Match.Optional(Object),\n      type: Match.Optional(String),\n      onError: Match.Optional(Function),\n      onAbort: Match.Optional(Function),\n      streams: Match.OneOf('dynamic', Number),\n      onStart: Match.Optional(Function),\n      fileName: Match.Optional(String),\n      isBase64: Match.Optional(Boolean),\n      transport: Match.OneOf('http', 'ddp'),\n      chunkSize: Match.OneOf('dynamic', Number),\n      onUploaded: Match.Optional(Function),\n      onProgress: Match.Optional(Function),\n      onBeforeUpload: Match.Optional(Function),\n      allowWebWorkers: Boolean\n    });\n\n    if (_this2.config.isBase64 === true) {\n      check(_this2.config.file, String);\n\n      if (!_this2.config.fileName) {\n        throw new Meteor.Error(400, '\"fileName\" must me specified for base64 upload!');\n      }\n\n      if (_this2.config.file.includes('data:')) {\n        _this2.config.file = _this2.config.file.replace('data:', '');\n      }\n\n      if (_this2.config.file.includes(',')) {\n        var _file = _this2.config.file.split(',');\n\n        _this2.fileData = {\n          size: Math.floor(_file[1].replace(/\\=/g, '').length / 4 * 3),\n          type: _file[0].split(';')[0],\n          name: _this2.config.fileName,\n          meta: _this2.config.meta\n        };\n        _this2.config.file = _file[1];\n      } else if (!_this2.config.type) {\n        throw new Meteor.Error(400, '\"type\" must me specified for base64 upload! And represent mime-type of the file');\n      } else {\n        _this2.fileData = {\n          size: Math.floor(_this2.config.file.replace(/\\=/g, '').length / 4 * 3),\n          type: _this2.config.type,\n          name: _this2.config.fileName,\n          meta: _this2.config.meta\n        };\n      }\n    }\n\n    if (_this2.config.file) {\n      if (!_this2.config.isBase64) {\n        try {\n          if (!_this2.config.file.name || !_this2.config.file.size) {\n            throw new Meteor.Error(500, 'Not a File!');\n          }\n        } catch (e) {\n          throw new Meteor.Error(500, '[FilesCollection] [insert] Insert method accepts File, not a FileList. You need to provide a real File. File must have `.name` property, and its size must be larger than zero.');\n        }\n\n        _this2.fileData = {\n          size: _this2.config.file.size,\n          type: _this2.config.type || _this2.config.file.type,\n          name: _this2.config.fileName || _this2.config.file.name,\n          meta: _this2.config.meta\n        };\n      }\n\n      if (_this2.collection.debug) {\n        console.time(\"insert \" + _this2.fileData.name);\n        console.time(\"loadFile \" + _this2.fileData.name);\n      }\n\n      if (_this2.collection._supportWebWorker && _this2.config.allowWebWorkers) {\n        try {\n          _this2.worker = new Worker(_this2.collection._webWorkerUrl);\n        } catch (wwError) {\n          _this2.worker = false;\n\n          _this2.collection._debug('[FilesCollection] [insert] [create WebWorker]: Can\\'t create WebWorker, fallback to MainThread', wwError);\n        }\n      } else {\n        _this2.worker = null;\n      }\n\n      _this2.startTime = {};\n      _this2.config.debug = _this2.collection.debug;\n      _this2.config._debug = _this2.collection._debug;\n      _this2.currentChunk = 0;\n      _this2.transferTime = 0;\n      _this2.trackerComp = null;\n      _this2.sentChunks = 0;\n      _this2.fileLength = 1;\n      _this2.EOFsent = false;\n      _this2.fileId = _this2.config.fileId || Random.id();\n      _this2.FSName = _this2.collection.namingFunction ? _this2.collection.namingFunction(_this2.fileData) : _this2.fileId;\n      _this2.pipes = [];\n      _this2.fileData = Object.assign(_this2.fileData, _this2.collection._getExt(_this2.fileData.name), {\n        mime: _this2.collection._getMimeType(_this2.fileData)\n      });\n      _this2.fileData['mime-type'] = _this2.fileData.mime;\n      _this2.result = new FileUpload(Object.assign({}, _this2.config, {\n        fileData: _this2.fileData,\n        fileId: _this2.fileId,\n        _Abort: _this2.collection._methodNames._Abort\n      }));\n\n      _this2.beforeunload = function (e) {\n        var message = helpers.isFunction(_this2.collection.onbeforeunloadMessage) ? _this2.collection.onbeforeunloadMessage.call(_this2.result, _this2.fileData) : _this2.collection.onbeforeunloadMessage;\n\n        if (e) {\n          e.returnValue = message;\n        }\n\n        return message;\n      };\n\n      _this2.result.config.beforeunload = _this2.beforeunload;\n      window.addEventListener('beforeunload', _this2.beforeunload, false);\n\n      _this2.result.config._onEnd = function () {\n        return _this2.emit('_onEnd');\n      };\n\n      _this2.addListener('end', _this2.end);\n\n      _this2.addListener('start', _this2.start);\n\n      _this2.addListener('upload', _this2.upload);\n\n      _this2.addListener('sendEOF', _this2.sendEOF);\n\n      _this2.addListener('prepare', _this2.prepare);\n\n      _this2.addListener('sendChunk', _this2.sendChunk);\n\n      _this2.addListener('proceedChunk', _this2.proceedChunk);\n\n      _this2.addListener('createStreams', _this2.createStreams);\n\n      _this2.addListener('calculateStats', helpers.throttle(function () {\n        var _t = _this2.transferTime / _this2.sentChunks / _this2.config.streams;\n\n        _this2.result.estimateTime.set(_t * (_this2.fileLength - _this2.sentChunks));\n\n        _this2.result.estimateSpeed.set(_this2.config.chunkSize / (_t / 1000));\n\n        var progress = Math.round(_this2.sentChunks / _this2.fileLength * 100);\n        var sentBytes = _this2.config.chunkSize * _this2.sentChunks;\n\n        if (sentBytes > _this2.fileData.size) {\n          // this case often occurs, when the last chunk\n          // is smaller than chunkSize, so we limit to fileSize\n          sentBytes = _this2.fileData.size;\n        }\n\n        _this2.result.progress.set(progress);\n\n        _this2.config.onProgress && _this2.config.onProgress.call(_this2.result, progress, _this2.fileData);\n\n        _this2.result.emit('progress', progress, _this2.fileData, {\n          chunksSent: _this2.sentChunks,\n          chunksLength: _this2.fileLength,\n          bytesSent: sentBytes\n        });\n      }, 250));\n\n      _this2.addListener('_onEnd', function () {\n        if (_this2.result.estimateTimer) {\n          Meteor.clearInterval(_this2.result.estimateTimer);\n        }\n\n        if (_this2.worker) {\n          _this2.worker.terminate();\n        }\n\n        if (_this2.trackerComp) {\n          _this2.trackerComp.stop();\n        }\n\n        if (_this2.beforeunload) {\n          window.removeEventListener('beforeunload', _this2.beforeunload, false);\n        }\n\n        if (_this2.result) {\n          return _this2.result.progress.set(0);\n        }\n\n        return void 0;\n      });\n    } else {\n      throw new Meteor.Error(500, '[FilesCollection] [insert] Have you forget to pass a File itself?');\n    }\n\n    return _this2;\n  }\n\n  var _proto2 = UploadInstance.prototype;\n\n  _proto2.end = function () {\n    function end(error, data) {\n      this.collection._debug('[FilesCollection] [UploadInstance] [end]', this.fileData.name);\n\n      if (this.collection.debug) {\n        console.timeEnd(\"insert \" + this.fileData.name);\n      }\n\n      this.emit('_onEnd');\n      this.result.emit('uploaded', error, data);\n      this.config.onUploaded && this.config.onUploaded.call(this.result, error, data);\n\n      if (error) {\n        this.collection._debug('[FilesCollection] [insert] [end] Error:', error);\n\n        this.result.abort();\n        this.result.state.set('aborted');\n        this.result.emit('error', error, this.fileData);\n        this.config.onError && this.config.onError.call(this.result, error, this.fileData);\n      } else {\n        this.result.state.set('completed');\n        this.collection.emit('afterUpload', data);\n      }\n\n      this.result.emit('end', error, data || this.fileData);\n      return this.result;\n    }\n\n    return end;\n  }();\n\n  _proto2.sendChunk = function () {\n    function sendChunk(evt) {\n      var _this3 = this;\n\n      var opts = {\n        fileId: this.fileId,\n        binData: evt.data.bin,\n        chunkId: evt.data.chunkId\n      };\n\n      if (this.config.isBase64) {\n        var pad = opts.binData.length % 4;\n\n        if (pad) {\n          var p = 0;\n\n          while (p < pad) {\n            opts.binData += '=';\n            p++;\n          }\n        }\n      }\n\n      this.emit('data', evt.data.bin);\n\n      if (this.pipes.length) {\n        for (var i = this.pipes.length - 1; i >= 0; i--) {\n          opts.binData = this.pipes[i](opts.binData);\n        }\n      }\n\n      if (this.fileLength === evt.data.chunkId) {\n        if (this.collection.debug) {\n          console.timeEnd(\"loadFile \" + this.fileData.name);\n        }\n\n        this.emit('readEnd');\n      }\n\n      if (opts.binData) {\n        if (this.config.transport === 'ddp') {\n          this.config.ddp.call(this.collection._methodNames._Write, opts, function (error) {\n            _this3.transferTime += +new Date() - _this3.startTime[opts.chunkId];\n\n            if (error) {\n              if (_this3.result.state.get() !== 'aborted') {\n                _this3.emit('end', error);\n              }\n            } else {\n              ++_this3.sentChunks;\n\n              if (_this3.sentChunks >= _this3.fileLength) {\n                _this3.emit('sendEOF');\n              } else if (_this3.currentChunk < _this3.fileLength) {\n                _this3.emit('upload');\n              }\n\n              _this3.emit('calculateStats');\n            }\n          });\n        } else {\n          HTTP.call('POST', \"\" + _rootUrl + this.collection.downloadRoute + \"/\" + this.collection.collectionName + \"/__upload\", {\n            content: opts.binData,\n            headers: {\n              'x-mtok': (helpers.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : void 0) || null,\n              'x-fileid': opts.fileId,\n              'x-chunkid': opts.chunkId,\n              'content-type': 'text/plain'\n            },\n            beforeSend: function (xhr) {\n              xhr.withCredentials = true;\n              return true;\n            }\n          }, function (error) {\n            _this3.transferTime += +new Date() - _this3.startTime[opts.chunkId];\n\n            if (error) {\n              if (\"\" + error === 'Error: network' || \"\" + error === 'Error: Connection lost') {\n                _this3.result.pause();\n              } else {\n                if (_this3.result.state.get() !== 'aborted') {\n                  _this3.emit('end', error);\n                }\n              }\n            } else {\n              ++_this3.sentChunks;\n\n              if (_this3.sentChunks >= _this3.fileLength) {\n                _this3.emit('sendEOF');\n              } else if (_this3.currentChunk < _this3.fileLength) {\n                _this3.emit('upload');\n              }\n\n              _this3.emit('calculateStats');\n            }\n          });\n        }\n      }\n    }\n\n    return sendChunk;\n  }();\n\n  _proto2.sendEOF = function () {\n    function sendEOF() {\n      var _this4 = this;\n\n      this.collection._debug('[FilesCollection] [UploadInstance] [sendEOF]', this.EOFsent);\n\n      if (!this.EOFsent) {\n        this.EOFsent = true;\n        var opts = {\n          eof: true,\n          fileId: this.fileId\n        };\n\n        if (this.config.transport === 'ddp') {\n          this.config.ddp.call(this.collection._methodNames._Write, opts, function (error, result) {\n            _this4.emit('end', error, result);\n          });\n        } else {\n          HTTP.call('POST', \"\" + _rootUrl + this.collection.downloadRoute + \"/\" + this.collection.collectionName + \"/__upload\", {\n            content: '',\n            headers: {\n              'x-eof': '1',\n              'x-mtok': (helpers.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : void 0) || null,\n              'x-fileId': opts.fileId,\n              'content-type': 'text/plain'\n            },\n            beforeSend: function (xhr) {\n              xhr.withCredentials = true;\n              return true;\n            }\n          }, function (error, _result) {\n            var result;\n\n            try {\n              result = JSON.parse((helpers.isObject(_result) ? _result.content : void 0) || {});\n            } catch (e) {\n              console.warn('Something went wrong! [sendEOF] method doesn\\'t returned JSON! Looks like you\\'re on Cordova app or behind proxy, switching to DDP transport is recommended.');\n              result = {};\n            }\n\n            if (result.meta) {\n              result.meta = fixJSONParse(result.meta);\n            }\n\n            _this4.emit('end', error, result);\n          });\n        }\n      }\n    }\n\n    return sendEOF;\n  }();\n\n  _proto2.proceedChunk = function () {\n    function proceedChunk(chunkId) {\n      var _this5 = this;\n\n      var chunk = this.config.file.slice(this.config.chunkSize * (chunkId - 1), this.config.chunkSize * chunkId);\n\n      if (this.config.isBase64) {\n        this.emit('sendChunk', {\n          data: {\n            bin: chunk,\n            chunkId: chunkId\n          }\n        });\n      } else {\n        var fileReader;\n\n        if (window.FileReader) {\n          fileReader = new window.FileReader();\n\n          fileReader.onloadend = function (evt) {\n            _this5.emit('sendChunk', {\n              data: {\n                bin: ((helpers.isObject(fileReader) ? fileReader.result : void 0) || (evt.srcElement ? evt.srcElement.result : void 0) || (evt.target ? evt.target.result : void 0)).split(',')[1],\n                chunkId: chunkId\n              }\n            });\n          };\n\n          fileReader.onerror = function (e) {\n            _this5.emit('end', (e.target || e.srcElement).error);\n          };\n\n          fileReader.readAsDataURL(chunk);\n        } else if (window.FileReaderSync) {\n          fileReader = new window.FileReaderSync();\n          this.emit('sendChunk', {\n            data: {\n              bin: fileReader.readAsDataURL(chunk).split(',')[1],\n              chunkId: chunkId\n            }\n          });\n        } else {\n          this.emit('end', 'File API is not supported in this Browser!');\n        }\n      }\n    }\n\n    return proceedChunk;\n  }();\n\n  _proto2.upload = function () {\n    function upload() {\n      if (this.result.onPause.get()) {\n        return this;\n      }\n\n      if (this.result.state.get() === 'aborted') {\n        return this;\n      }\n\n      if (this.currentChunk <= this.fileLength) {\n        ++this.currentChunk;\n\n        if (this.worker) {\n          this.worker.postMessage({\n            f: this.config.file,\n            sc: this.sentChunks,\n            cc: this.currentChunk,\n            cs: this.config.chunkSize,\n            ib: this.config.isBase64\n          });\n        } else {\n          this.emit('proceedChunk', this.currentChunk);\n        }\n      } else {\n        this.emit('sendEOF');\n      }\n\n      this.startTime[this.currentChunk] = +new Date();\n      return this;\n    }\n\n    return upload;\n  }();\n\n  _proto2.createStreams = function () {\n    function createStreams() {\n      this.collection._debug('[FilesCollection] [UploadInstance] [createStreams]');\n\n      var i = 1;\n\n      while (i <= this.config.streams) {\n        this.emit('upload');\n        i++;\n      }\n    }\n\n    return createStreams;\n  }();\n\n  _proto2.prepare = function () {\n    function prepare() {\n      var _this6 = this;\n\n      var _len;\n\n      this.config.onStart && this.config.onStart.call(this.result, null, this.fileData);\n      this.result.emit('start', null, this.fileData);\n\n      if (this.config.chunkSize === 'dynamic') {\n        this.config.chunkSize = this.fileData.size / 1000;\n\n        if (this.config.chunkSize < 327680) {\n          this.config.chunkSize = 327680;\n        } else if (this.config.chunkSize > 1048576) {\n          this.config.chunkSize = 1048576;\n        }\n\n        if (this.config.transport === 'http') {\n          this.config.chunkSize = Math.round(this.config.chunkSize / 2);\n        } else if (isSafari) {\n          this.config.chunkSize = Math.ceil(this.config.chunkSize / 8);\n        }\n      }\n\n      if (this.config.isBase64) {\n        this.config.chunkSize = Math.floor(this.config.chunkSize / 4) * 4;\n        _len = Math.ceil(this.config.file.length / this.config.chunkSize);\n      } else {\n        this.config.chunkSize = Math.floor(this.config.chunkSize / 8) * 8;\n        _len = Math.ceil(this.fileData.size / this.config.chunkSize);\n      }\n\n      if (this.config.streams === 'dynamic') {\n        this.config.streams = helpers.clone(_len);\n\n        if (this.config.streams > 24) {\n          this.config.streams = 24;\n        }\n\n        if (this.config.transport === 'http') {\n          this.config.streams = Math.round(this.config.streams / 2);\n        } else if (isSafari) {\n          this.config.streams = 1;\n        }\n      }\n\n      this.fileLength = _len <= 0 ? 1 : _len;\n\n      if (this.config.streams > this.fileLength) {\n        this.config.streams = this.fileLength;\n      }\n\n      this.result.config.fileLength = this.fileLength;\n      var opts = {\n        file: this.fileData,\n        fileId: this.fileId,\n        chunkSize: this.config.isBase64 ? this.config.chunkSize / 4 * 3 : this.config.chunkSize,\n        fileLength: this.fileLength\n      };\n\n      if (this.FSName !== this.fileId) {\n        opts.FSName = this.FSName;\n      }\n\n      var handleStart = function (error) {\n        if (error) {\n          _this6.collection._debug('[FilesCollection] [_Start] Error:', error);\n\n          _this6.emit('end', error);\n        } else {\n          _this6.result.continueFunc = function () {\n            _this6.collection._debug('[FilesCollection] [insert] [continueFunc]');\n\n            _this6.emit('createStreams');\n          };\n\n          _this6.emit('createStreams');\n        }\n      };\n\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Start, opts, handleStart);\n      } else {\n        if (helpers.isObject(opts.file) ? opts.file.meta : void 0) {\n          opts.file.meta = fixJSONStringify(opts.file.meta);\n        }\n\n        HTTP.call('POST', \"\" + _rootUrl + this.collection.downloadRoute + \"/\" + this.collection.collectionName + \"/__upload\", {\n          data: opts,\n          headers: {\n            'x-start': '1',\n            'x-mtok': (helpers.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : void 0) || null\n          },\n          beforeSend: function (xhr) {\n            xhr.withCredentials = true;\n            return true;\n          }\n        }, handleStart);\n      }\n    }\n\n    return prepare;\n  }();\n\n  _proto2.pipe = function () {\n    function pipe(func) {\n      this.pipes.push(func);\n      return this;\n    }\n\n    return pipe;\n  }();\n\n  _proto2.start = function () {\n    function start() {\n      var _this7 = this;\n\n      var isUploadAllowed;\n\n      if (this.fileData.size <= 0) {\n        this.end(new Meteor.Error(400, 'Can\\'t upload empty file'));\n        return this.result;\n      }\n\n      if (this.config.onBeforeUpload && helpers.isFunction(this.config.onBeforeUpload)) {\n        isUploadAllowed = this.config.onBeforeUpload.call(Object.assign({}, this.result, this.collection._getUser()), this.fileData);\n\n        if (isUploadAllowed !== true) {\n          return this.end(new Meteor.Error(403, helpers.isString(isUploadAllowed) ? isUploadAllowed : 'config.onBeforeUpload() returned false'));\n        }\n      }\n\n      if (this.collection.onBeforeUpload && helpers.isFunction(this.collection.onBeforeUpload)) {\n        isUploadAllowed = this.collection.onBeforeUpload.call(Object.assign({}, this.result, this.collection._getUser()), this.fileData);\n\n        if (isUploadAllowed !== true) {\n          return this.end(new Meteor.Error(403, helpers.isString(isUploadAllowed) ? isUploadAllowed : 'collection.onBeforeUpload() returned false'));\n        }\n      }\n\n      Tracker.autorun(function (computation) {\n        _this7.trackerComp = computation;\n\n        if (!_this7.result.onPause.curValue && !Meteor.status().connected) {\n          _this7.collection._debug('[FilesCollection] [insert] [Tracker] [pause]');\n\n          _this7.result.pause();\n        }\n      });\n\n      if (this.worker) {\n        this.collection._debug('[FilesCollection] [insert] using WebWorkers');\n\n        this.worker.onmessage = function (evt) {\n          if (evt.data.error) {\n            _this7.collection._debug('[FilesCollection] [insert] [worker] [onmessage] [ERROR:]', evt.data.error);\n\n            _this7.emit('proceedChunk', evt.data.chunkId);\n          } else {\n            _this7.emit('sendChunk', evt);\n          }\n        };\n\n        this.worker.onerror = function (e) {\n          _this7.collection._debug('[FilesCollection] [insert] [worker] [onerror] [ERROR:]', e);\n\n          _this7.emit('end', e.message);\n        };\n      } else {\n        this.collection._debug('[FilesCollection] [insert] using MainThread');\n      }\n\n      this.emit('prepare');\n      return this.result;\n    }\n\n    return start;\n  }();\n\n  _proto2.manual = function () {\n    function manual() {\n      var _this8 = this;\n\n      this.result.start = function () {\n        _this8.emit('start');\n      };\n\n      var self = this;\n\n      this.result.pipe = function (func) {\n        self.pipe(func);\n        return this;\n      };\n\n      return this.result;\n    }\n\n    return manual;\n  }();\n\n  return UploadInstance;\n}(EventEmitter);","map":{"version":3,"sources":["packages/ostrio:files/upload.js"],"names":["_inheritsLoose","module","link","default","v","export","FileUpload","UploadInstance","HTTP","Meteor","Random","Tracker","ReactiveVar","EventEmitter","check","Match","fixJSONParse","fixJSONStringify","helpers","_rootUrl","window","__meteor_runtime_config__","MOBILE_ROOT_URL","ROOT_URL","replace","isSafari","test","navigator","userAgent","config","_debug","isBase64","file","Object","assign","clone","fileData","state","onPause","progress","continueFunc","estimateTime","estimateSpeed","estimateTimer","setInterval","get","_currentTime","set","pause","emit","continue","toggle","abort","removeEventListener","beforeunload","_onEnd","onAbort","call","debug","console","timeEnd","name","ddp","_Abort","fileId","collection","meta","streams","isString","transport","toLowerCase","chunkSize","isBoolean","allowWebWorkers","Any","Optional","String","type","onError","Function","OneOf","Number","onStart","fileName","Boolean","onUploaded","onProgress","onBeforeUpload","Error","includes","_file","split","size","Math","floor","length","e","time","_supportWebWorker","worker","Worker","_webWorkerUrl","wwError","startTime","currentChunk","transferTime","trackerComp","sentChunks","fileLength","EOFsent","id","FSName","namingFunction","pipes","_getExt","mime","_getMimeType","result","_methodNames","message","isFunction","onbeforeunloadMessage","returnValue","addEventListener","addListener","end","start","upload","sendEOF","prepare","sendChunk","proceedChunk","createStreams","throttle","_t","round","sentBytes","chunksSent","chunksLength","bytesSent","clearInterval","terminate","stop","error","data","evt","opts","binData","bin","chunkId","pad","p","i","_Write","Date","downloadRoute","collectionName","content","headers","isObject","connection","_lastSessionId","beforeSend","xhr","withCredentials","eof","_result","JSON","parse","warn","chunk","slice","fileReader","FileReader","onloadend","srcElement","target","onerror","readAsDataURL","FileReaderSync","postMessage","f","sc","cc","cs","ib","_len","ceil","handleStart","_Start","pipe","func","push","isUploadAllowed","_getUser","autorun","computation","curValue","status","connected","onmessage","manual","self"],"mappings":"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","sourcesContent":["import { HTTP }         from 'meteor/http';\nimport { Meteor }       from 'meteor/meteor';\nimport { Random }       from 'meteor/random';\nimport { Tracker }      from 'meteor/tracker';\nimport { ReactiveVar }  from 'meteor/reactive-var';\nimport { EventEmitter } from 'eventemitter3';\nimport { check, Match } from 'meteor/check';\nimport { fixJSONParse, fixJSONStringify, helpers } from './lib.js';\n\nconst _rootUrl = (window.__meteor_runtime_config__.MOBILE_ROOT_URL || window.__meteor_runtime_config__.ROOT_URL).replace(/\\/+$/, '');\nconst isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\n/*\n * @locus Client\n * @name FileUpload\n * @class FileUpload\n * @summary Internal Class, instance of this class is returned from `.insert()` method\n */\nexport class FileUpload extends EventEmitter {\n  constructor(config) {\n    super();\n    this.config = config;\n    this.config._debug('[FilesCollection] [FileUpload] [constructor]');\n\n    if (!this.config.isBase64) {\n      this.file        = Object.assign({}, helpers.clone(this.config.file), this.config.fileData);\n    } else {\n      this.file        = this.config.fileData;\n    }\n    this.state         = new ReactiveVar('active');\n    this.onPause       = new ReactiveVar(false);\n    this.progress      = new ReactiveVar(0);\n    this.continueFunc  = () => { };\n    this.estimateTime  = new ReactiveVar(1000);\n    this.estimateSpeed = new ReactiveVar(0);\n    this.estimateTimer = Meteor.setInterval(() => {\n      if (this.state.get() === 'active') {\n        const _currentTime = this.estimateTime.get();\n        if (_currentTime > 1000) {\n          this.estimateTime.set(_currentTime - 1000);\n        }\n      }\n    }, 1000);\n  }\n  pause() {\n    this.config._debug('[FilesCollection] [insert] [.pause()]');\n    if (!this.onPause.get()) {\n      this.onPause.set(true);\n      this.state.set('paused');\n      this.emit('pause', this.file);\n    }\n  }\n  continue() {\n    this.config._debug('[FilesCollection] [insert] [.continue()]');\n    if (this.onPause.get()) {\n      this.onPause.set(false);\n      this.state.set('active');\n      this.emit('continue', this.file);\n      this.continueFunc();\n    }\n  }\n  toggle() {\n    this.config._debug('[FilesCollection] [insert] [.toggle()]');\n    if (this.onPause.get()) {\n      this.continue();\n    } else {\n      this.pause();\n    }\n  }\n  abort() {\n    this.config._debug('[FilesCollection] [insert] [.abort()]');\n    window.removeEventListener('beforeunload', this.config.beforeunload, false);\n    this.pause();\n    this.config._onEnd();\n    this.state.set('aborted');\n    this.config.onAbort && this.config.onAbort.call(this, this.file);\n    this.emit('abort', this.file);\n    if (this.config.debug) {\n      console.timeEnd(`insert ${this.config.fileData.name}`);\n    }\n\n    this.config.ddp.call(this.config._Abort, this.config.fileId);\n  }\n}\n\n/*\n * @locus Client\n * @name UploadInstance\n * @class UploadInstance\n * @summary Internal Class, used for file upload\n */\nexport class UploadInstance extends EventEmitter {\n  constructor(config, collection) {\n    super();\n    this.config     = config;\n    this.collection = collection;\n    this.collection._debug('[FilesCollection] [insert()]');\n\n    if (!this.config.ddp) {\n      this.config.ddp = this.collection.ddp;\n    }\n\n    if (!this.config.meta) {\n      this.config.meta = {};\n    }\n\n    if (!this.config.streams) {\n      this.config.streams = 2;\n    }\n\n    if (this.config.streams < 1) {\n      this.config.streams = 2;\n    }\n\n    if (!helpers.isString(this.config.transport)) {\n      this.config.transport = 'ddp';\n    }\n\n    this.config.transport = this.config.transport.toLowerCase();\n\n    if (this.config.transport !== 'ddp' && this.config.transport !== 'http') {\n      this.config.transport = 'ddp';\n    }\n\n    if (!this.config.chunkSize) {\n      this.config.chunkSize = this.collection.chunkSize;\n    }\n\n    if (!helpers.isBoolean(this.config.allowWebWorkers)) {\n      this.config.allowWebWorkers = true;\n    }\n\n    check(this.config, {\n      ddp: Match.Any,\n      file: Match.Any,\n      fileId: Match.Optional(String),\n      meta: Match.Optional(Object),\n      type: Match.Optional(String),\n      onError: Match.Optional(Function),\n      onAbort: Match.Optional(Function),\n      streams: Match.OneOf('dynamic', Number),\n      onStart: Match.Optional(Function),\n      fileName: Match.Optional(String),\n      isBase64: Match.Optional(Boolean),\n      transport: Match.OneOf('http', 'ddp'),\n      chunkSize: Match.OneOf('dynamic', Number),\n      onUploaded: Match.Optional(Function),\n      onProgress: Match.Optional(Function),\n      onBeforeUpload: Match.Optional(Function),\n      allowWebWorkers: Boolean\n    });\n\n    if (this.config.isBase64 === true) {\n      check(this.config.file, String);\n\n      if (!this.config.fileName) {\n        throw new Meteor.Error(400, '\"fileName\" must me specified for base64 upload!');\n      }\n\n      if (this.config.file.includes('data:')) {\n        this.config.file = this.config.file.replace('data:', '');\n      }\n\n      if (this.config.file.includes(',')) {\n        const _file = this.config.file.split(',');\n        this.fileData = {\n          size: Math.floor(((_file[1].replace(/\\=/g, '')).length / 4) * 3),\n          type: _file[0].split(';')[0],\n          name: this.config.fileName,\n          meta: this.config.meta\n        };\n        this.config.file = _file[1];\n      } else if (!this.config.type) {\n        throw new Meteor.Error(400, '\"type\" must me specified for base64 upload! And represent mime-type of the file');\n      } else {\n        this.fileData = {\n          size: Math.floor(((this.config.file.replace(/\\=/g, '')).length / 4) * 3),\n          type: this.config.type,\n          name: this.config.fileName,\n          meta: this.config.meta\n        };\n      }\n    }\n\n    if (this.config.file) {\n      if (!this.config.isBase64) {\n        try {\n          if (!this.config.file.name || !this.config.file.size) {\n            throw new Meteor.Error(500, 'Not a File!');\n          }\n        } catch (e) {\n          throw new Meteor.Error(500, '[FilesCollection] [insert] Insert method accepts File, not a FileList. You need to provide a real File. File must have `.name` property, and its size must be larger than zero.');\n        }\n\n        this.fileData = {\n          size: this.config.file.size,\n          type: this.config.type || this.config.file.type,\n          name: this.config.fileName || this.config.file.name,\n          meta: this.config.meta\n        };\n      }\n\n      if (this.collection.debug) {\n        console.time(`insert ${this.fileData.name}`);\n        console.time(`loadFile ${this.fileData.name}`);\n      }\n\n      if (this.collection._supportWebWorker && this.config.allowWebWorkers) {\n        try {\n          this.worker = new Worker(this.collection._webWorkerUrl);\n        } catch (wwError) {\n          this.worker = false;\n          this.collection._debug('[FilesCollection] [insert] [create WebWorker]: Can\\'t create WebWorker, fallback to MainThread', wwError);\n        }\n      } else {\n        this.worker = null;\n      }\n\n      this.startTime     = {};\n      this.config.debug  = this.collection.debug;\n      this.config._debug = this.collection._debug;\n      this.currentChunk  = 0;\n      this.transferTime  = 0;\n      this.trackerComp   = null;\n      this.sentChunks    = 0;\n      this.fileLength    = 1;\n      this.EOFsent       = false;\n      this.fileId        = this.config.fileId || Random.id();\n      this.FSName        = this.collection.namingFunction ? this.collection.namingFunction(this.fileData) : this.fileId;\n      this.pipes         = [];\n\n      this.fileData = Object.assign(this.fileData, this.collection._getExt(this.fileData.name), {mime: this.collection._getMimeType(this.fileData)});\n      this.fileData['mime-type'] = this.fileData.mime;\n\n      this.result = new FileUpload(Object.assign({}, this.config, {\n        fileData: this.fileData,\n        fileId: this.fileId,\n        _Abort: this.collection._methodNames._Abort\n      }));\n\n      this.beforeunload = (e) => {\n        const message = helpers.isFunction(this.collection.onbeforeunloadMessage) ? this.collection.onbeforeunloadMessage.call(this.result, this.fileData) : this.collection.onbeforeunloadMessage;\n\n        if (e) {\n          e.returnValue = message;\n        }\n        return message;\n      };\n\n      this.result.config.beforeunload = this.beforeunload;\n      window.addEventListener('beforeunload', this.beforeunload, false);\n\n      this.result.config._onEnd = () => this.emit('_onEnd');\n\n      this.addListener('end', this.end);\n      this.addListener('start', this.start);\n      this.addListener('upload', this.upload);\n      this.addListener('sendEOF', this.sendEOF);\n      this.addListener('prepare', this.prepare);\n      this.addListener('sendChunk', this.sendChunk);\n      this.addListener('proceedChunk', this.proceedChunk);\n      this.addListener('createStreams', this.createStreams);\n\n      this.addListener('calculateStats', helpers.throttle(() => {\n        const _t = (this.transferTime / this.sentChunks) / this.config.streams;\n        this.result.estimateTime.set((_t * (this.fileLength - this.sentChunks)));\n        this.result.estimateSpeed.set((this.config.chunkSize / (_t / 1000)));\n\n        const progress = Math.round((this.sentChunks / this.fileLength) * 100);\n        let sentBytes = this.config.chunkSize * this.sentChunks;\n        if (sentBytes > this.fileData.size) {\n          // this case often occurs, when the last chunk\n          // is smaller than chunkSize, so we limit to fileSize\n          sentBytes = this.fileData.size;\n        }\n\n        this.result.progress.set(progress);\n        this.config.onProgress && this.config.onProgress.call(this.result, progress, this.fileData);\n        this.result.emit('progress', progress, this.fileData, { chunksSent: this.sentChunks, chunksLength: this.fileLength, bytesSent: sentBytes });\n      }, 250));\n\n      this.addListener('_onEnd', () => {\n        if (this.result.estimateTimer) {\n          Meteor.clearInterval(this.result.estimateTimer);\n        }\n        if (this.worker) {\n          this.worker.terminate();\n        }\n        if (this.trackerComp) {\n          this.trackerComp.stop();\n        }\n        if (this.beforeunload) {\n          window.removeEventListener('beforeunload', this.beforeunload, false);\n        }\n        if (this.result) {\n          return this.result.progress.set(0);\n        }\n        return void 0;\n      });\n    } else {\n      throw new Meteor.Error(500, '[FilesCollection] [insert] Have you forget to pass a File itself?');\n    }\n  }\n\n  end(error, data) {\n    this.collection._debug('[FilesCollection] [UploadInstance] [end]', this.fileData.name);\n    if (this.collection.debug) {\n      console.timeEnd(`insert ${this.fileData.name}`);\n    }\n\n    this.emit('_onEnd');\n    this.result.emit('uploaded', error, data);\n    this.config.onUploaded && this.config.onUploaded.call(this.result, error, data);\n\n    if (error) {\n      this.collection._debug('[FilesCollection] [insert] [end] Error:', error);\n      this.result.abort();\n      this.result.state.set('aborted');\n      this.result.emit('error', error, this.fileData);\n      this.config.onError && this.config.onError.call(this.result, error, this.fileData);\n    } else {\n      this.result.state.set('completed');\n      this.collection.emit('afterUpload', data);\n    }\n    this.result.emit('end', error, (data || this.fileData));\n    return this.result;\n  }\n\n  sendChunk(evt) {\n    const opts = {\n      fileId: this.fileId,\n      binData: evt.data.bin,\n      chunkId: evt.data.chunkId\n    };\n\n    if (this.config.isBase64) {\n      const pad = opts.binData.length % 4;\n      if (pad) {\n        let p = 0;\n        while (p < pad) {\n          opts.binData += '=';\n          p++;\n        }\n      }\n    }\n\n    this.emit('data', evt.data.bin);\n    if (this.pipes.length) {\n      for (let i = this.pipes.length - 1; i >= 0; i--) {\n        opts.binData = this.pipes[i](opts.binData);\n      }\n    }\n\n    if (this.fileLength === evt.data.chunkId) {\n      if (this.collection.debug) {\n        console.timeEnd(`loadFile ${this.fileData.name}`);\n      }\n      this.emit('readEnd');\n    }\n\n    if (opts.binData) {\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Write, opts, (error) => {\n          this.transferTime += (+new Date) - this.startTime[opts.chunkId];\n          if (error) {\n            if (this.result.state.get() !== 'aborted') {\n              this.emit('end', error);\n            }\n          } else {\n            ++this.sentChunks;\n            if (this.sentChunks >= this.fileLength) {\n              this.emit('sendEOF');\n            } else if (this.currentChunk < this.fileLength) {\n              this.emit('upload');\n            }\n            this.emit('calculateStats');\n          }\n        });\n      } else {\n        HTTP.call('POST', `${_rootUrl}${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n          content: opts.binData,\n          headers: {\n            'x-mtok': (helpers.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : void 0) || null,\n            'x-fileid': opts.fileId,\n            'x-chunkid': opts.chunkId,\n            'content-type': 'text/plain'\n          },\n          beforeSend(xhr) {\n            xhr.withCredentials = true;\n            return true;\n          }\n        }, (error) => {\n          this.transferTime += +new Date() - this.startTime[opts.chunkId];\n          if (error) {\n            if (`${error}` === 'Error: network' || `${error}` === 'Error: Connection lost') {\n              this.result.pause();\n            } else {\n              if (this.result.state.get() !== 'aborted') {\n                this.emit('end', error);\n              }\n            }\n          } else {\n            ++this.sentChunks;\n            if (this.sentChunks >= this.fileLength) {\n              this.emit('sendEOF');\n            } else if (this.currentChunk < this.fileLength) {\n              this.emit('upload');\n            }\n            this.emit('calculateStats');\n          }\n        });\n      }\n    }\n  }\n\n  sendEOF() {\n    this.collection._debug('[FilesCollection] [UploadInstance] [sendEOF]', this.EOFsent);\n    if (!this.EOFsent) {\n      this.EOFsent = true;\n      const opts = {\n        eof: true,\n        fileId: this.fileId\n      };\n\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Write, opts, (error, result) => {\n          this.emit('end', error, result);\n        });\n      } else {\n        HTTP.call('POST', `${_rootUrl}${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n          content: '',\n          headers: {\n            'x-eof': '1',\n            'x-mtok': (helpers.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : void 0) || null,\n            'x-fileId': opts.fileId,\n            'content-type': 'text/plain'\n          },\n          beforeSend(xhr) {\n            xhr.withCredentials = true;\n            return true;\n          }\n        }, (error, _result) => {\n          let result;\n          try {\n            result = JSON.parse((helpers.isObject(_result) ? _result.content : void 0) || {});\n          } catch (e) {\n            console.warn('Something went wrong! [sendEOF] method doesn\\'t returned JSON! Looks like you\\'re on Cordova app or behind proxy, switching to DDP transport is recommended.');\n            result = {};\n          }\n\n          if (result.meta) {\n            result.meta = fixJSONParse(result.meta);\n          }\n\n          this.emit('end', error, result);\n        });\n      }\n    }\n  }\n\n  proceedChunk(chunkId) {\n    const chunk = this.config.file.slice((this.config.chunkSize * (chunkId - 1)), (this.config.chunkSize * chunkId));\n\n    if (this.config.isBase64) {\n      this.emit('sendChunk', {\n        data: {\n          bin: chunk,\n          chunkId\n        }\n      });\n    } else {\n      let fileReader;\n      if (window.FileReader) {\n        fileReader = new window.FileReader;\n\n        fileReader.onloadend = (evt) => {\n          this.emit('sendChunk', {\n            data: {\n              bin: ((helpers.isObject(fileReader) ? fileReader.result : void 0) || (evt.srcElement ? evt.srcElement.result : void 0) || (evt.target ? evt.target.result : void 0)).split(',')[1],\n              chunkId\n            }\n          });\n        };\n\n        fileReader.onerror = (e) => {\n          this.emit('end', (e.target || e.srcElement).error);\n        };\n\n        fileReader.readAsDataURL(chunk);\n      } else if (window.FileReaderSync) {\n        fileReader = new window.FileReaderSync;\n\n        this.emit('sendChunk', {\n          data: {\n            bin: fileReader.readAsDataURL(chunk).split(',')[1],\n            chunkId\n          }\n        });\n      } else {\n        this.emit('end', 'File API is not supported in this Browser!');\n      }\n    }\n  }\n\n  upload() {\n    if (this.result.onPause.get()) {\n      return this;\n    }\n\n    if (this.result.state.get() === 'aborted') {\n      return this;\n    }\n\n    if (this.currentChunk <= this.fileLength) {\n      ++this.currentChunk;\n      if (this.worker) {\n        this.worker.postMessage({\n          f: this.config.file,\n          sc: this.sentChunks,\n          cc: this.currentChunk,\n          cs: this.config.chunkSize,\n          ib: this.config.isBase64\n        });\n      } else {\n        this.emit('proceedChunk', this.currentChunk);\n      }\n    } else {\n      this.emit('sendEOF');\n    }\n    this.startTime[this.currentChunk] = +new Date();\n    return this;\n  }\n\n  createStreams() {\n    this.collection._debug('[FilesCollection] [UploadInstance] [createStreams]');\n    let i = 1;\n    while (i <= this.config.streams) {\n      this.emit('upload');\n      i++;\n    }\n  }\n\n  prepare() {\n    let _len;\n\n    this.config.onStart && this.config.onStart.call(this.result, null, this.fileData);\n    this.result.emit('start', null, this.fileData);\n\n    if (this.config.chunkSize === 'dynamic') {\n      this.config.chunkSize = this.fileData.size / 1000;\n      if (this.config.chunkSize < 327680) {\n        this.config.chunkSize = 327680;\n      } else if (this.config.chunkSize > 1048576) {\n        this.config.chunkSize = 1048576;\n      }\n\n      if (this.config.transport === 'http') {\n        this.config.chunkSize = Math.round(this.config.chunkSize / 2);\n      } else if (isSafari) {\n        this.config.chunkSize = Math.ceil(this.config.chunkSize / 8);\n      }\n    }\n\n    if (this.config.isBase64) {\n      this.config.chunkSize = Math.floor(this.config.chunkSize / 4) * 4;\n      _len = Math.ceil(this.config.file.length / this.config.chunkSize);\n    } else {\n      this.config.chunkSize = Math.floor(this.config.chunkSize / 8) * 8;\n      _len = Math.ceil(this.fileData.size / this.config.chunkSize);\n    }\n\n    if (this.config.streams === 'dynamic') {\n      this.config.streams = helpers.clone(_len);\n      if (this.config.streams > 24) { this.config.streams = 24; }\n\n      if (this.config.transport === 'http') {\n        this.config.streams = Math.round(this.config.streams / 2);\n      } else if (isSafari) {\n        this.config.streams = 1;\n      }\n    }\n\n    this.fileLength = _len <= 0 ? 1 : _len;\n    if (this.config.streams > this.fileLength) {\n      this.config.streams = this.fileLength;\n    }\n    this.result.config.fileLength = this.fileLength;\n\n    const opts = {\n      file: this.fileData,\n      fileId: this.fileId,\n      chunkSize: this.config.isBase64 ? ((this.config.chunkSize  / 4) * 3) : this.config.chunkSize,\n      fileLength: this.fileLength\n    };\n\n    if (this.FSName !== this.fileId) {\n      opts.FSName = this.FSName;\n    }\n\n    const handleStart = (error) => {\n      if (error) {\n        this.collection._debug('[FilesCollection] [_Start] Error:', error);\n        this.emit('end', error);\n      } else {\n        this.result.continueFunc = () => {\n          this.collection._debug('[FilesCollection] [insert] [continueFunc]');\n          this.emit('createStreams');\n        };\n        this.emit('createStreams');\n      }\n    };\n\n    if (this.config.transport === 'ddp') {\n      this.config.ddp.call(this.collection._methodNames._Start, opts, handleStart);\n    } else {\n      if (helpers.isObject(opts.file) ? opts.file.meta : void 0) {\n        opts.file.meta = fixJSONStringify(opts.file.meta);\n      }\n\n      HTTP.call('POST', `${_rootUrl}${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n        data: opts,\n        headers: {\n          'x-start': '1',\n          'x-mtok': (helpers.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : void 0) || null\n        },\n        beforeSend(xhr) {\n          xhr.withCredentials = true;\n          return true;\n        }\n      }, handleStart);\n    }\n  }\n\n  pipe(func) {\n    this.pipes.push(func);\n    return this;\n  }\n\n  start() {\n    let isUploadAllowed;\n    if (this.fileData.size <= 0) {\n      this.end(new Meteor.Error(400, 'Can\\'t upload empty file'));\n      return this.result;\n    }\n\n    if (this.config.onBeforeUpload && helpers.isFunction(this.config.onBeforeUpload)) {\n      isUploadAllowed = this.config.onBeforeUpload.call(Object.assign({}, this.result, this.collection._getUser()), this.fileData);\n      if (isUploadAllowed !== true) {\n        return this.end(new Meteor.Error(403, helpers.isString(isUploadAllowed) ? isUploadAllowed : 'config.onBeforeUpload() returned false'));\n      }\n    }\n\n    if (this.collection.onBeforeUpload && helpers.isFunction(this.collection.onBeforeUpload)) {\n      isUploadAllowed = this.collection.onBeforeUpload.call(Object.assign({}, this.result, this.collection._getUser()), this.fileData);\n      if (isUploadAllowed !== true) {\n        return this.end(new Meteor.Error(403, helpers.isString(isUploadAllowed) ? isUploadAllowed : 'collection.onBeforeUpload() returned false'));\n      }\n    }\n\n    Tracker.autorun((computation) => {\n      this.trackerComp = computation;\n      if (!this.result.onPause.curValue && !Meteor.status().connected) {\n        this.collection._debug('[FilesCollection] [insert] [Tracker] [pause]');\n        this.result.pause();\n      }\n    });\n\n    if (this.worker) {\n      this.collection._debug('[FilesCollection] [insert] using WebWorkers');\n      this.worker.onmessage = (evt) => {\n        if (evt.data.error) {\n          this.collection._debug('[FilesCollection] [insert] [worker] [onmessage] [ERROR:]', evt.data.error);\n          this.emit('proceedChunk', evt.data.chunkId);\n        } else {\n          this.emit('sendChunk', evt);\n        }\n      };\n\n      this.worker.onerror = (e) => {\n        this.collection._debug('[FilesCollection] [insert] [worker] [onerror] [ERROR:]', e);\n        this.emit('end', e.message);\n      };\n    } else {\n      this.collection._debug('[FilesCollection] [insert] using MainThread');\n    }\n\n    this.emit('prepare');\n    return this.result;\n  }\n\n  manual() {\n    this.result.start = () => {\n      this.emit('start');\n    };\n\n    const self = this;\n    this.result.pipe = function (func) {\n      self.pipe(func);\n      return this;\n    };\n    return this.result;\n  }\n}\n"]},"sourceType":"module","hash":"efe5c64f34eec46de37dc7f4c5e395be429b03be"}
